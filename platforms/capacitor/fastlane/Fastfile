# Fastfile for nChat Capacitor
# Automates building and deploying iOS and Android apps

default_platform(:ios)

# iOS Platform
platform :ios do
  desc "Build iOS app for development"
  lane :dev do
    setup_ci if ENV['CI']

    # Install dependencies
    cocoapods(
      podfile: "./ios/App/Podfile",
      clean_install: true
    )

    # Build for simulator
    build_app(
      workspace: "./ios/App/App.xcworkspace",
      scheme: "App",
      configuration: "Debug",
      destination: "generic/platform=iOS Simulator",
      skip_archive: true,
      skip_codesigning: true,
      derived_data_path: "./ios/build",
      output_directory: "./dist/ios",
      output_name: "nchat-dev.app"
    )

    UI.success("‚úÖ iOS development build completed!")
  end

  desc "Build iOS app for release"
  lane :release do
    setup_ci if ENV['CI']

    # Ensure git is clean for version bumping
    ensure_git_status_clean unless ENV['CI']

    # Increment build number
    build_number = number_of_commits
    increment_build_number(
      build_number: build_number,
      xcodeproj: "./ios/App/App.xcodeproj"
    )

    # Install dependencies
    cocoapods(
      podfile: "./ios/App/Podfile",
      clean_install: true
    )

    # Get certificates and provisioning profiles
    match(
      type: "appstore",
      readonly: ENV['CI'] == 'true',
      app_identifier: "io.nself.chat"
    )

    # Build and archive
    build_app(
      workspace: "./ios/App/App.xcworkspace",
      scheme: "App",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./dist/ios",
      output_name: "nchat.ipa",
      include_symbols: true,
      include_bitcode: false,
      export_options: {
        uploadBitcode: false,
        uploadSymbols: true,
        compileBitcode: false,
        manageAppVersionAndBuildNumber: false
      }
    )

    UI.success("‚úÖ iOS release build completed!")
    UI.success("üì¶ IPA: ./dist/ios/nchat.ipa")
  end

  desc "Upload iOS app to TestFlight"
  lane :beta do
    # Build release
    release

    # Upload to TestFlight
    upload_to_testflight(
      api_key_path: ENV['APP_STORE_CONNECT_API_KEY_PATH'],
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      notify_external_testers: false,
      changelog: "Internal test build from CI/CD"
    )

    UI.success("‚úÖ iOS app uploaded to TestFlight!")
  end

  desc "Upload iOS app to App Store"
  lane :deploy do
    # Build release
    release

    # Upload to App Store
    upload_to_app_store(
      api_key_path: ENV['APP_STORE_CONNECT_API_KEY_PATH'],
      force: true,
      submit_for_review: false,
      automatic_release: false,
      skip_metadata: false,
      skip_screenshots: false,
      precheck_include_in_app_purchases: false
    )

    UI.success("‚úÖ iOS app uploaded to App Store!")
  end

  desc "Run iOS tests"
  lane :test do
    run_tests(
      workspace: "./ios/App/App.xcworkspace",
      scheme: "App",
      devices: ["iPhone 15 Pro", "iPad Pro (12.9-inch) (6th generation)"],
      clean: true,
      output_directory: "./test-results/ios",
      result_bundle: true
    )

    UI.success("‚úÖ iOS tests completed!")
  end

  desc "Take iOS screenshots for App Store"
  lane :screenshots do
    snapshot(
      workspace: "./ios/App/App.xcworkspace",
      scheme: "App",
      devices: [
        "iPhone 15 Pro Max",
        "iPhone 15 Pro",
        "iPhone 15",
        "iPhone SE (3rd generation)",
        "iPad Pro (12.9-inch) (6th generation)",
        "iPad Pro (11-inch) (4th generation)"
      ],
      languages: ["en-US"],
      output_directory: "./screenshots/ios",
      clear_previous_screenshots: true,
      override_status_bar: true
    )

    UI.success("‚úÖ iOS screenshots captured!")
  end

  desc "Setup iOS signing with match"
  lane :setup_signing do
    match(
      type: "development",
      app_identifier: "io.nself.chat",
      readonly: false
    )

    match(
      type: "appstore",
      app_identifier: "io.nself.chat",
      readonly: false
    )

    UI.success("‚úÖ iOS signing setup completed!")
  end
end

# Android Platform
platform :android do
  desc "Build Android app for development"
  lane :dev do
    gradle(
      task: "clean assembleDebug",
      project_dir: "./android",
      print_command: true,
      properties: {
        "android.injected.version.code" => number_of_commits,
        "android.injected.version.name" => get_version_name
      }
    )

    # Copy APK to dist
    sh("mkdir -p ../dist/android")
    sh("cp ../android/app/build/outputs/apk/debug/app-debug.apk ../dist/android/nchat-debug.apk")

    UI.success("‚úÖ Android development build completed!")
    UI.success("üì¶ APK: ./dist/android/nchat-debug.apk")
  end

  desc "Build Android app for release"
  lane :release do
    # Ensure git is clean
    ensure_git_status_clean unless ENV['CI']

    # Build release AAB and APK
    gradle(
      task: "clean bundleRelease assembleRelease",
      project_dir: "./android",
      print_command: true,
      properties: {
        "android.injected.version.code" => number_of_commits,
        "android.injected.version.name" => get_version_name,
        "NCHAT_RELEASE_STORE_FILE" => ENV["NCHAT_RELEASE_STORE_FILE"],
        "NCHAT_RELEASE_STORE_PASSWORD" => ENV["NCHAT_RELEASE_STORE_PASSWORD"],
        "NCHAT_RELEASE_KEY_ALIAS" => ENV["NCHAT_RELEASE_KEY_ALIAS"],
        "NCHAT_RELEASE_KEY_PASSWORD" => ENV["NCHAT_RELEASE_KEY_PASSWORD"]
      }
    )

    # Copy outputs to dist
    sh("mkdir -p ../dist/android")
    sh("cp ../android/app/build/outputs/bundle/release/app-release.aab ../dist/android/nchat-release.aab")
    sh("cp ../android/app/build/outputs/apk/release/app-release.apk ../dist/android/nchat-release.apk 2>/dev/null || true")

    UI.success("‚úÖ Android release build completed!")
    UI.success("üì¶ AAB: ./dist/android/nchat-release.aab")
    UI.success("üì¶ APK: ./dist/android/nchat-release.apk")
  end

  desc "Build Android beta variant"
  lane :beta_build do
    gradle(
      task: "clean bundleBeta",
      project_dir: "./android",
      print_command: true,
      properties: {
        "android.injected.version.code" => number_of_commits,
        "android.injected.version.name" => get_version_name + "-beta",
        "NCHAT_RELEASE_STORE_FILE" => ENV["NCHAT_RELEASE_STORE_FILE"],
        "NCHAT_RELEASE_STORE_PASSWORD" => ENV["NCHAT_RELEASE_STORE_PASSWORD"],
        "NCHAT_RELEASE_KEY_ALIAS" => ENV["NCHAT_RELEASE_KEY_ALIAS"],
        "NCHAT_RELEASE_KEY_PASSWORD" => ENV["NCHAT_RELEASE_KEY_PASSWORD"]
      }
    )

    sh("mkdir -p ../dist/android")
    sh("cp ../android/app/build/outputs/bundle/beta/app-beta.aab ../dist/android/nchat-beta.aab")

    UI.success("‚úÖ Android beta build completed!")
  end

  desc "Upload Android app to Play Store (internal track)"
  lane :internal do
    release

    upload_to_play_store(
      track: "internal",
      aab: "./dist/android/nchat-release.aab",
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: "draft",
      json_key: ENV['PLAY_STORE_JSON_KEY']
    )

    UI.success("‚úÖ Android app uploaded to Play Store (internal track)!")
  end

  desc "Upload Android app to Play Store (beta track)"
  lane :beta do
    release

    upload_to_play_store(
      track: "beta",
      aab: "./dist/android/nchat-release.aab",
      skip_upload_apk: true,
      skip_upload_metadata: false,
      skip_upload_changelogs: false,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: "draft",
      json_key: ENV['PLAY_STORE_JSON_KEY']
    )

    UI.success("‚úÖ Android app uploaded to Play Store (beta track)!")
  end

  desc "Upload Android app to Play Store (production)"
  lane :deploy do
    release

    upload_to_play_store(
      track: "production",
      aab: "./dist/android/nchat-release.aab",
      skip_upload_apk: true,
      skip_upload_metadata: false,
      skip_upload_changelogs: false,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      release_status: "draft",
      rollout: "0.1",  # Start with 10% rollout
      json_key: ENV['PLAY_STORE_JSON_KEY']
    )

    UI.success("‚úÖ Android app uploaded to Play Store (production)!")
  end

  desc "Run Android tests"
  lane :test do
    gradle(
      task: "test",
      project_dir: "./android",
      print_command: true
    )

    UI.success("‚úÖ Android tests completed!")
  end

  desc "Take Android screenshots for Play Store"
  lane :screenshots do
    screengrab(
      locales: ["en-US"],
      clear_previous_screenshots: true,
      output_directory: "./screenshots/android",
      app_package_name: "io.nself.chat",
      use_adb_root: false
    )

    UI.success("‚úÖ Android screenshots captured!")
  end

  desc "Setup Android signing keystore"
  lane :setup_signing do
    UI.important("To setup Android signing:")
    UI.message("1. Create a keystore:")
    UI.message("   keytool -genkeypair -v -storetype PKCS12 -keystore nchat-release.keystore -alias nchat -keyalg RSA -keysize 2048 -validity 10000")
    UI.message("2. Set environment variables:")
    UI.message("   NCHAT_RELEASE_STORE_FILE=<path-to-keystore>")
    UI.message("   NCHAT_RELEASE_STORE_PASSWORD=<password>")
    UI.message("   NCHAT_RELEASE_KEY_ALIAS=nchat")
    UI.message("   NCHAT_RELEASE_KEY_PASSWORD=<password>")
    UI.message("3. For CI/CD, base64 encode the keystore:")
    UI.message("   base64 nchat-release.keystore > keystore.base64")
  end
end

# Helper methods
def get_version_name
  # Read version from package.json
  package_json = File.read("../../package.json")
  version = JSON.parse(package_json)["version"]
  version
end

def number_of_commits
  # Use git commit count as build number
  sh("git rev-list --count HEAD").strip.to_i
end

# Error handling
error do |lane, exception, options|
  UI.error("‚ùå Error in lane #{lane}:")
  UI.error(exception.message)
  UI.error(exception.backtrace.join("\n")) if ENV['DEBUG']
end
