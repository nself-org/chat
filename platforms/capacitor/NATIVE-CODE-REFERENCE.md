# Native Code Reference - nChat Mobile Apps

This document serves as a reference for the native code implementations created for iOS and Android apps. The actual native code files are located in gitignored directories (`ios/` and `android/`) which are generated by Capacitor.

## Overview

The nChat mobile apps include extensive native functionality implemented in Swift (iOS) and Kotlin (Android). Below is a comprehensive reference of all native code created.

## iOS Native Code

### Location

All iOS native code is located in the `ios/` directory after running `npx cap add ios`.

### Plugins

#### 1. BiometricAuthPlugin.swift

**Path**: `ios/Plugin/BiometricAuthPlugin.swift`

Face ID and Touch ID authentication plugin.

**Key Methods**:

- `checkAvailability()` - Check if biometrics are available
- `authenticate()` - Authenticate with biometrics
- `authenticateWithPasscode()` - Authenticate with device passcode
- `getBiometryType()` - Get type of biometric (face/fingerprint)

**Features**:

- Face ID support
- Touch ID support
- Passcode fallback
- Biometry type detection
- Error handling with specific error codes

**Dependencies**:

- LocalAuthentication framework

#### 2. CallKitPlugin.swift (Already exists)

**Path**: `ios/Plugin/CallKitPlugin.swift`

Native call integration using CallKit.

**Key Methods**:

- `configure()` - Configure CallKit provider
- `reportIncomingCall()` - Show incoming call UI
- `startCall()` - Start outgoing call
- `reportCallConnected()` - Mark call as connected
- `reportCallEnded()` - End call
- `setMuted()` - Mute/unmute call
- `setOnHold()` - Hold/unhold call

**Features**:

- Native iOS call UI
- VoIP push notification integration
- Call history integration
- Audio session management
- Call state management

**Dependencies**:

- CallKit framework
- AVFoundation framework

### Extensions

#### 3. NChatWidget.swift

**Path**: `ios/Widget/NChatWidget.swift`

Home screen widget for iOS 14+.

**Widget Sizes**:

- **Small**: App icon + unread count
- **Medium**: 2 recent messages with sender and channel
- **Large**: 3 recent messages with full details

**Features**:

- Displays recent messages from shared UserDefaults
- Shows unread count badge
- Updates every 15 minutes
- Taps open main app
- Dark mode support
- SwiftUI implementation

**Data Source**:

- Reads from `UserDefaults(suiteName: "group.io.nself.chat")`
- Keys: `recent_messages`, `unread_count`

**Dependencies**:

- WidgetKit framework
- SwiftUI framework

#### 4. ShareViewController.swift

**Path**: `ios/ShareExtension/ShareViewController.swift`

Share extension for receiving shared content.

**Supported Content Types**:

- Text (plain text, URLs)
- Images (JPEG, PNG, HEIC)
- Videos (MP4, MOV)
- Files (any file type)

**Features**:

- Extracts shared content
- Saves to shared UserDefaults
- Opens main app via deep link
- Channel selection UI
- Preview of shared content

**Data Flow**:

1. Extract content from share extension
2. Save to `UserDefaults(suiteName: "group.io.nself.chat")`
3. Open main app with `nchat://share` deep link
4. Main app reads from UserDefaults and displays share UI

#### 5. AppClipViewController.swift

**Path**: `ios/AppClip/AppClipViewController.swift`

App Clip for quick access without full app installation.

**Use Cases**:

- Join public channels via QR code
- View shared messages
- Quick preview of nChat
- Prompt to download full app

**Features**:

- Lightweight UI (<10MB)
- NFC/QR code invocation
- Universal link handling
- App Store sheet for full app download
- Channel join functionality

**URL Handling**:

- Supports `https://nchat.app/join/*` URLs
- Parses channel information from URL
- Deep link to specific content

### Configuration Files

#### 6. Info.plist.template

**Path**: `ios/App/Info.plist.template`

Complete iOS configuration template.

**Key Configurations**:

- Privacy permission descriptions (Camera, Photos, Microphone, etc.)
- Background modes (Audio, VoIP, Remote notifications, Fetch)
- URL schemes (`nchat://`)
- Associated domains for Universal Links
- App Groups (`group.io.nself.chat`)
- Push notification entitlements
- Face ID usage description
- Document type declarations

#### 7. apple-app-site-association

**Path**: `ios/App/.well-known/apple-app-site-association`

Universal Links configuration.

**Supported Paths**:

- `/join/*` - Join channel
- `/channel/*` - Open channel
- `/message/*` - Open message
- `/invite/*` - Accept invite
- `/share/*` - Shared content
- `/call/*` - Join call

**App Clips**:

- Includes App Clip configuration
- Same path handling as main app

---

## Android Native Code

### Location

All Android native code is located in the `android/` directory after running `npx cap add android`.

### Plugins

#### 1. BiometricAuthPlugin.kt

**Path**: `android/src/main/java/io/nself/chat/plugins/BiometricAuthPlugin.kt`

Biometric authentication plugin using AndroidX Biometric library.

**Key Methods**:

- `checkAvailability()` - Check biometric availability
- `authenticate()` - Authenticate with biometrics
- `authenticateWithPasscode()` - Authenticate with device credentials
- `getBiometryType()` - Get biometric type

**Features**:

- Fingerprint authentication
- Face unlock (device-dependent)
- Device credential fallback
- BiometricPrompt UI
- Error handling with codes

**Supported Biometrics**:

- Fingerprint (most common)
- Face unlock (Android 10+, device-dependent)
- Iris (rare)

**Dependencies**:

- androidx.biometric:biometric

#### 2. CallKitPlugin.kt (Already exists)

**Path**: `android/src/main/java/io/nself/chat/plugins/CallKitPlugin.kt`

Native call integration using Android Telecom Manager.

**Key Methods**:

- `configure()` - Configure Telecom Manager
- `reportIncomingCall()` - Show incoming call
- `startCall()` - Start outgoing call
- `reportCallConnected()` - Mark connected
- `reportCallEnded()` - End call
- `setMuted()` - Mute/unmute
- `setOnHold()` - Hold/unhold
- `requestPermissions()` - Request call permissions

**Features**:

- Native Android call UI
- Call history integration
- Connection service
- Phone account management
- Audio routing

**Dependencies**:

- android.telecom package

#### 3. CallConnectionService.kt

**Path**: `android/src/main/java/io/nself/chat/plugins/CallConnectionService.kt` (included in CallKitPlugin.kt)

Connection service for handling call states.

**Capabilities**:

- Hold support
- Mute support
- Video calling support (bidirectional)
- VoIP audio mode

### Activities

#### 4. ShareActivity.kt

**Path**: `android/src/main/java/io/nself/chat/ShareActivity.kt`

Activity for receiving shared content from other apps.

**Supported Content Types**:

- Text (`text/plain`)
- Images (`image/*`)
- Videos (`video/*`)
- Files (any MIME type)
- Multiple files (`ACTION_SEND_MULTIPLE`)

**Features**:

- Extracts shared content
- Saves to SharedPreferences
- Opens main app
- Handles multiple files
- URI permissions

**Data Flow**:

1. Receive share intent
2. Extract content and URIs
3. Save to `SharedPreferences("nchat_share")`
4. Launch MainActivity with share data
5. Main app reads and displays share UI

### Widgets

#### 5. NChatWidgetProvider.kt

**Path**: `android/src/main/java/io/nself/chat/widgets/NChatWidgetProvider.kt`

Home screen widget provider.

**Features**:

- Shows recent messages
- Displays unread count
- RemoteViews for list of messages
- Updates on data change
- Tap to open app

**Update Mechanism**:

- `updateAppWidget()` - Updates single widget
- `updateAllWidgets()` - Updates all instances
- Data from SharedPreferences

**Layout**:

- Widget container with gradient background
- Unread count badge
- ListView of recent messages
- Click intent to open app

### Managers

#### 6. ShortcutManager.kt

**Path**: `android/src/main/java/io/nself/chat/shortcuts/ShortcutManager.kt`

App shortcuts manager for dynamic and static shortcuts.

**Static Shortcuts**:

- New Message
- Search
- Start Call

**Dynamic Shortcuts**:

- Up to 4 recent channels
- Updated programmatically
- Can be pinned to home screen

**Features**:

- Create dynamic shortcuts for channels
- Update shortcut rankings
- Report shortcut usage
- Pin shortcut support
- Remove shortcuts

**Dependencies**:

- androidx.core.content.pm.ShortcutManagerCompat

### Configuration Files

#### 7. AndroidManifest.xml.template

**Path**: `android/app/src/main/AndroidManifest.xml.template`

Complete Android manifest template.

**Key Configurations**:

- Permissions (Camera, Storage, Microphone, Contacts, etc.)
- MainActivity with deep link intent filters
- ShareActivity with share intent filters
- Widget receiver and service
- File provider
- Notification service
- Call connection service
- Boot receiver
- Firebase metadata
- App shortcuts metadata

**Intent Filters**:

- **Deep Links**: `nchat://` custom scheme
- **App Links**: `https://nchat.app/*` verified links
- **Share**: All major MIME types
- **Home**: Launcher intent

#### 8. strings.xml

**Path**: `android/app/src/main/res/values/strings.xml`

String resources for Android app.

**Categories**:

- App info (name, package)
- Deep link hosts
- Notification channels
- Widget strings
- Share extension strings
- Shortcut labels
- Permission descriptions
- Biometric strings
- Error messages

---

## Build Scripts

### iOS Build Script

**Path**: `scripts/build-ios.sh`

**Features**:

- Builds web app
- Exports for Capacitor
- Syncs to iOS
- Updates version/build number
- Builds for simulator or device
- Creates archive for release
- Exports IPA
- Optional TestFlight upload

**Usage**:

```bash
./scripts/build-ios.sh debug          # Debug build for simulator
./scripts/build-ios.sh release app-store  # Release for App Store
```

### Android Build Script

**Path**: `scripts/build-android.sh`

**Features**:

- Builds web app
- Exports for Capacitor
- Syncs to Android
- Updates version code
- Builds debug APK or release AAB/APK
- Signs APK if keystore configured
- Copies to dist folder

**Usage**:

```bash
./scripts/build-android.sh debug      # Debug APK
./scripts/build-android.sh release aab    # Release AAB
./scripts/build-android.sh release apk    # Release APK
```

---

## Assets Configuration

### Capacitor Assets Config

**Path**: `assets/capacitor.assets.json`

Configuration for generating app icons and splash screens.

**Source Assets** (place in `assets/`):

- `icon.png` - 1024x1024 app icon
- `icon-foreground.png` - Android adaptive foreground
- `icon-background.png` - Android adaptive background
- `splash.png` - Light mode splash
- `splash-dark.png` - Dark mode splash

**Generated Assets**:

- **iOS**: Multiple icon sizes, splash screens for all devices
- **Android**: Icons for all densities, adaptive icons, splash screens

**Generation**:

```bash
npx @capacitor/assets generate
```

---

## Store Metadata

### iOS App Store

**Path**: `metadata/ios/app-store-metadata.json`

Complete metadata for App Store Connect:

- App name and bundle ID
- Categories
- Keywords and descriptions
- Screenshots specifications
- What's new (release notes)
- URLs (support, marketing, privacy)
- In-app purchases
- Test credentials

### Android Play Store

**Path**: `metadata/android/play-store-metadata.json`

Complete metadata for Google Play Console:

- App name and package
- Category and content rating
- Short and full descriptions
- What's new
- Screenshots specifications
- Feature graphic
- Pricing and in-app products
- Contact details
- Test instructions

---

## CI/CD Workflows

### iOS Workflow

**Path**: `.github/workflows/build-capacitor-ios.yml`

**Features**:

- Builds on macOS runner
- Installs dependencies
- Builds web app
- Syncs to iOS
- Configures signing
- Builds and archives
- Exports IPA
- Uploads to TestFlight
- Artifact upload

**Secrets Required**:

- `APPLE_ID`
- `APPLE_PASSWORD`
- `TEAM_ID`
- `CERTIFICATES_P12`
- `CERTIFICATES_PASSWORD`
- `PROVISIONING_PROFILE`

### Android Workflow

**Path**: `.github/workflows/build-capacitor-android.yml`

**Features**:

- Builds on Ubuntu runner
- Installs dependencies
- Builds web app
- Syncs to Android
- Configures signing
- Builds AAB/APK
- Signs release builds
- Uploads to Play Console
- Artifact upload

**Secrets Required**:

- `KEYSTORE_FILE`
- `KEYSTORE_PASSWORD`
- `KEY_ALIAS`
- `KEY_PASSWORD`
- `PLAY_STORE_JSON_KEY`

---

## Shared App Group (iOS)

**Suite Name**: `group.io.nself.chat`

**Shared Data**:

1. **Widget Data**:
   - `recent_messages` - JSON array of recent messages
   - `unread_count` - Integer unread count

2. **Share Extension Data**:
   - `pending_share` - JSON object of pending share

3. **App Clips Data**:
   - Channel info from invitations

---

## Shared Preferences (Android)

**Preferences Files**:

1. **Widget**: `nchat_widget`
   - `unread_count` - Unread message count
   - `recent_messages` - Serialized message data

2. **Share**: `nchat_share`
   - `pending_share` - JSON of pending share
   - `timestamp` - Share timestamp

---

## Plugin Registration

### Registering Custom Plugins

**iOS** (`ios/App/App/capacitor.config.json`):

```json
{
  "plugins": {
    "BiometricAuth": {
      "className": "BiometricAuthPlugin"
    },
    "CallKit": {
      "className": "CallKitPlugin"
    }
  }
}
```

**Android** (`android/app/src/main/java/io/nself/chat/MainActivity.java`):

```java
public class MainActivity extends BridgeActivity {
  @Override
  public void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);

    registerPlugin(BiometricAuthPlugin.class);
    registerPlugin(CallKitPlugin.class);
  }
}
```

---

## Development Checklist

When adding new native code:

1. ✅ Create native files in appropriate directories
2. ✅ Register plugins in both platforms
3. ✅ Update TypeScript wrapper in `src/native/`
4. ✅ Add permissions to Info.plist/AndroidManifest
5. ✅ Update this reference document
6. ✅ Test on real devices
7. ✅ Add to CI/CD if needed

---

## Testing Native Code

### iOS Testing

1. Build and run on simulator
2. Test on physical device
3. Test all biometric scenarios
4. Test share extension from Photos/Safari
5. Test widgets on home screen
6. Test App Clips with QR code
7. Test push notifications
8. Test CallKit integration

### Android Testing

1. Build and run on emulator
2. Test on physical device
3. Test biometric authentication
4. Test share target from apps
5. Test widgets on home screen
6. Test app shortcuts
7. Test push notifications
8. Test Telecom integration

---

## Notes

- All native code directories (`ios/` and `android/`) are gitignored because they're generated by Capacitor
- Native source files should be recreated after running `npx cap add ios/android`
- This document serves as the source of truth for native implementations
- Templates and configurations are version-controlled
- Actual native projects should be regenerated from templates

---

**Last Updated**: 2026-01-30
**Version**: 1.0.0
**Capacitor Version**: 6.2.0
