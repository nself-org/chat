#
# Electron Builder Configuration
# Complete production-ready build configuration for all platforms
#
# Supports:
# - Windows: NSIS installer + Portable
# - macOS: DMG + PKG (with code signing & notarization)
# - Linux: AppImage, .deb, .rpm, .tar.gz
#

appId: org.nself.nchat
productName: nchat
copyright: Copyright Â© 2024-2026 nself
asar: true
compression: maximum
electronLanguages:
  - en-US

# Directories
directories:
  output: ../../dist-electron
  buildResources: resources
  app: .

# Files to include in the app package
files:
  - main.js
  - preload.js
  - main/**/*.js
  - preload/**/*.js
  - resources/**/*
  - node_modules/**/*
  - package.json
  # Exclude source files and maps from production builds
  - "!**/*.ts"
  - "!**/*.map"
  - "!**/tsconfig*.json"
  - "!**/*.md"
  - "!README.md"

# Extra resources (the Next.js build output)
extraResources:
  - from: ../../out
    to: app
    filter:
      - "**/*"

# macOS Configuration
mac:
  category: public.app-category.productivity
  icon: resources/icons/icon.icns
  hardenedRuntime: true
  gatekeeperAssess: false
  entitlements: resources/entitlements.mac.plist
  entitlementsInherit: resources/entitlements.mac.plist
  # Code signing identity (set via CSC_NAME environment variable)
  # CSC_LINK and CSC_KEY_PASSWORD required for signing
  target:
    - target: dmg
      arch:
        - x64
        - arm64
    - target: pkg
      arch:
        - x64
        - arm64
    - target: zip
      arch:
        - x64
        - arm64
  artifactName: "${productName}-${version}-${os}-${arch}.${ext}"
  darkModeSupport: true
  minimumSystemVersion: "10.15"
  type: distribution
  extendInfo:
    NSCameraUsageDescription: "nchat needs camera access for video calls"
    NSMicrophoneUsageDescription: "nchat needs microphone access for voice and video calls"
    NSScreenCaptureDescription: "nchat needs screen recording permission for screen sharing"
    NSPhotoLibraryUsageDescription: "nchat needs photo library access to share images"
    NSAppleEventsUsageDescription: "nchat uses automation for deep linking"
    CFBundleURLTypes:
      - CFBundleURLName: nchat URL
        CFBundleURLSchemes:
          - nchat
    LSApplicationCategoryType: public.app-category.productivity

# DMG Configuration
dmg:
  title: "${productName} ${version}"
  icon: resources/icons/icon.icns
  background: resources/dmg-background.png
  backgroundColor: "#2c3e50"
  window:
    width: 660
    height: 480
  contents:
    - x: 180
      y: 220
      type: file
    - x: 480
      y: 220
      type: link
      path: /Applications
  iconSize: 128
  iconTextSize: 13
  format: ULFO

# PKG Configuration
pkg:
  allowAnywhere: true
  allowCurrentUserHome: false
  allowRootDirectory: false
  installLocation: /Applications
  scripts: scripts/macos-installer
  # License file shown during installation
  license: ../../LICENSE

# Windows Configuration
win:
  icon: resources/icons/icon.ico
  target:
    - target: nsis
      arch:
        - x64
        - ia32
    - target: portable
      arch:
        - x64
  artifactName: "${productName}-${version}-${os}-${arch}.${ext}"
  publisherName: nself
  # Code signing (set via WIN_CSC_LINK and WIN_CSC_KEY_PASSWORD)
  signingHashAlgorithms:
    - sha256
  signDlls: false
  rfc3161TimeStampServer: http://timestamp.digicert.com
  timeStampServer: http://timestamp.digicert.com
  verifyUpdateCodeSignature: true

# NSIS Installer Configuration (Windows)
nsis:
  oneClick: false
  perMachine: false
  allowToChangeInstallationDirectory: true
  allowElevation: true
  installerIcon: resources/icons/icon.ico
  uninstallerIcon: resources/icons/icon.ico
  installerHeaderIcon: resources/icons/icon.ico
  installerSidebar: resources/installer-sidebar.bmp
  uninstallerSidebar: resources/installer-sidebar.bmp
  createDesktopShortcut: always
  createStartMenuShortcut: true
  shortcutName: nchat
  deleteAppDataOnUninstall: false
  runAfterFinish: true
  menuCategory: false
  artifactName: "${productName}-Setup-${version}.${ext}"
  displayLanguageSelector: false
  installerLanguages:
    - en-US
  language: en-US
  warningsAsErrors: false
  # Custom NSIS includes for advanced features
  include: scripts/installer.nsh
  # Protocol handler registration
  perMachineInstall: false
  # Uninstall display name
  uninstallDisplayName: "${productName}"

# Portable Configuration (Windows)
portable:
  artifactName: "${productName}-${version}-Portable.${ext}"

# Linux Configuration
linux:
  icon: resources/icons
  category: Network;InstantMessaging;Chat
  target:
    - target: AppImage
      arch:
        - x64
    - target: deb
      arch:
        - x64
    - target: rpm
      arch:
        - x64
    - target: tar.gz
      arch:
        - x64
  artifactName: "${productName}-${version}-${os}-${arch}.${ext}"
  maintainer: nself <hello@nself.org>
  vendor: nself
  synopsis: "Team Communication Platform"
  description: >
    nchat Desktop - White-label team communication platform with Slack and Telegram features.
    Built with Electron and Next.js for a seamless cross-platform experience.
  desktop:
    Name: nchat
    GenericName: Team Communication
    Comment: Team Communication Platform
    Type: Application
    Categories: Network;InstantMessaging;Chat;GNOME;GTK;
    Keywords: chat;messaging;team;communication;collaboration;slack;telegram;
    Terminal: false
    StartupNotify: true
    StartupWMClass: nchat
    MimeType: x-scheme-handler/nchat;

# AppImage Configuration
appImage:
  artifactName: "${productName}-${version}-${arch}.AppImage"
  synopsis: "Team Communication Platform"
  description: >
    nchat Desktop - Team communication platform
  category: Network
  license: MIT
  # Desktop integration
  desktop:
    Name: nchat
    Comment: Team Communication Platform
    Categories: Network;InstantMessaging;Chat;

# Debian Package Configuration
deb:
  artifactName: "${productName}_${version}_${arch}.deb"
  packageCategory: net
  priority: optional
  depends:
    - gconf2
    - gconf-service
    - libnotify4
    - libappindicator1
    - libxtst6
    - libnss3
    - libxss1
    - libasound2
  compression: xz
  afterInstall: scripts/linux-postinstall.sh
  afterRemove: scripts/linux-postremove.sh

# RPM Package Configuration
rpm:
  artifactName: "${productName}-${version}.${arch}.rpm"
  packageCategory: Applications/Internet
  vendor: nself
  license: MIT
  compression: xz
  depends:
    - libnotify
    - libappindicator-gtk3
    - libXtst
    - nss
    - libXScrnSaver
    - alsa-lib
  afterInstall: scripts/linux-postinstall.sh
  afterRemove: scripts/linux-postremove.sh

# Protocol Registration
protocols:
  - name: nchat
    role: Viewer
    schemes:
      - nchat

# Auto-Update Configuration
publish:
  - provider: github
    owner: nself
    repo: nself-chat
    releaseType: release
    publishAutoUpdate: true
    # Private repo support (requires GH_TOKEN)
    private: false
  # Alternative: S3 bucket for self-hosted updates
  # - provider: s3
  #   bucket: nchat-releases
  #   region: us-east-1
  #   channel: latest
  #   path: /releases

# Snap Configuration (Future)
# snap:
#   confinement: strict
#   grade: stable
#   summary: Team Communication Platform
#   description: >
#     nchat Desktop - White-label team communication platform

# Flatpak Configuration (Future)
# flatpak:
#   runtime: org.freedesktop.Platform
#   runtimeVersion: "22.08"
#   sdk: org.freedesktop.Sdk

# File Associations (if needed)
fileAssociations:
  - ext: nchat
    name: nchat Workspace
    description: nchat Workspace File
    icon: resources/icons/file-icon.icns
    role: Editor

# Build configuration
extraMetadata:
  main: main.js
  name: nchat-desktop

# Advanced configuration
buildVersion: "${version}"
buildDependenciesFromSource: false
nodeGypRebuild: false
npmRebuild: true

# Security
afterSign: scripts/notarize.js
afterPack: scripts/after-pack.js

# Compression and optimization
removePackageScripts: true
removePackageKeywords: true
includePdb: false

# Debugging
detectUpdateChannel: true
forceCodeSigning: false
