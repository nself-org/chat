# Fastfile for nChat React Native
# Automates building and deploying iOS and Android apps

default_platform(:ios)

# iOS Lanes
platform :ios do
  desc "Build iOS app for development"
  lane :dev do
    setup_ci if ENV['CI']

    match(
      type: "development",
      readonly: true
    )

    build_app(
      scheme: "nchat",
      workspace: "./ios/nchat.xcworkspace",
      configuration: "Debug",
      export_method: "development",
      output_directory: "./build/ios",
      output_name: "nchat-dev.ipa"
    )
  end

  desc "Build iOS app for release"
  lane :release do
    setup_ci if ENV['CI']

    increment_build_number(
      xcodeproj: "./ios/nchat.xcodeproj"
    )

    match(
      type: "appstore",
      readonly: true
    )

    build_app(
      scheme: "nchat",
      workspace: "./ios/nchat.xcworkspace",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build/ios",
      output_name: "nchat.ipa"
    )
  end

  desc "Submit iOS app to TestFlight"
  lane :beta do
    release
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )
  end

  desc "Submit iOS app to App Store"
  lane :deploy do
    release
    upload_to_app_store(
      force: true,
      submit_for_review: false
    )
  end

  desc "Run iOS tests"
  lane :test do
    run_tests(
      scheme: "nchat",
      workspace: "./ios/nchat.xcworkspace",
      devices: ["iPhone 15 Pro"]
    )
  end

  desc "Take iOS screenshots"
  lane :screenshots do
    snapshot
  end
end

# Android Lanes
platform :android do
  desc "Build Android app for development"
  lane :dev do
    gradle(
      task: "clean assembleDebug",
      project_dir: "./android"
    )
  end

  desc "Build Android app for release"
  lane :release do
    gradle(
      task: "clean bundleRelease",
      project_dir: "./android",
      properties: {
        "android.injected.signing.store.file" => ENV["NCHAT_RELEASE_STORE_FILE"],
        "android.injected.signing.store.password" => ENV["NCHAT_RELEASE_STORE_PASSWORD"],
        "android.injected.signing.key.alias" => ENV["NCHAT_RELEASE_KEY_ALIAS"],
        "android.injected.signing.key.password" => ENV["NCHAT_RELEASE_KEY_PASSWORD"],
      }
    )
  end

  desc "Submit Android app to Play Store (internal track)"
  lane :internal do
    release
    upload_to_play_store(
      track: "internal",
      skip_upload_apk: true,
      aab: "./android/app/build/outputs/bundle/release/app-release.aab"
    )
  end

  desc "Submit Android app to Play Store (beta track)"
  lane :beta do
    release
    upload_to_play_store(
      track: "beta",
      skip_upload_apk: true,
      aab: "./android/app/build/outputs/bundle/release/app-release.aab"
    )
  end

  desc "Submit Android app to Play Store (production)"
  lane :deploy do
    release
    upload_to_play_store(
      track: "production",
      skip_upload_apk: true,
      aab: "./android/app/build/outputs/bundle/release/app-release.aab"
    )
  end

  desc "Run Android tests"
  lane :test do
    gradle(
      task: "test",
      project_dir: "./android"
    )
  end

  desc "Take Android screenshots"
  lane :screenshots do
    screengrab
  end
end

# Error handling
error do |lane, exception|
  # Send error notification
  puts "Error in lane #{lane}: #{exception.message}"
end
