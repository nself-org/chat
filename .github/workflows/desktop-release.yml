name: Desktop Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.8.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '9.15.4'

jobs:
  # Build Next.js app first (shared across all platforms)
  build-web:
    name: Build Web App
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v5
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('frontend/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Next.js app
        run: pnpm build
        env:
          NEXT_PUBLIC_USE_DEV_AUTH: 'false'
          NEXT_PUBLIC_ENV: 'production'

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: nextjs-build
          path: |
            frontend/.next/
            frontend/public/
          retention-days: 1

  # Build Windows installer
  build-windows:
    name: Build Windows
    needs: build-web
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, ia32]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download Next.js build
        uses: actions/download-artifact@v7
        with:
          name: nextjs-build
          path: frontend

      - name: Install Electron dependencies
        working-directory: frontend/platforms/electron
        run: npm install

      - name: Build Electron (TypeScript)
        working-directory: frontend/platforms/electron
        run: npm run build:all

      - name: Build Windows installer
        working-directory: frontend/platforms/electron
        run: npm run dist:win -- --${{ matrix.arch }}
        env:
          # Code signing (if available)
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}
          # GitHub token for auto-updater
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v6
        with:
          name: windows-${{ matrix.arch }}
          path: frontend/dist-electron/*.exe
          retention-days: 7

  # Build macOS DMG and PKG
  build-macos:
    name: Build macOS
    needs: build-web
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download Next.js build
        uses: actions/download-artifact@v7
        with:
          name: nextjs-build
          path: frontend

      - name: Install Electron dependencies
        working-directory: frontend/platforms/electron
        run: npm install

      - name: Install @electron/notarize
        working-directory: frontend/platforms/electron
        run: npm install --save-dev @electron/notarize

      - name: Build Electron (TypeScript)
        working-directory: frontend/platforms/electron
        run: npm run build:all

      - name: Import Code Signing Certificate
        if: env.CSC_LINK != ''
        run: |
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -l ~/Library/Keychains/build.keychain

          # Import certificate
          echo "$CSC_LINK" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$CSC_KEY_PASSWORD" -T /usr/bin/codesign -T /usr/bin/productbuild
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain

          # Clean up
          rm certificate.p12
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}

      - name: Build macOS DMG/PKG
        working-directory: frontend/platforms/electron
        run: npm run dist:mac -- --${{ matrix.arch }}
        env:
          # Code signing
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          CSC_NAME: ${{ secrets.CSC_NAME }}
          # Notarization
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # Alternative: API Key method (preferred)
          # APPLE_API_KEY: ${{ secrets.APPLE_API_KEY }}
          # APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          # APPLE_API_ISSUER: ${{ secrets.APPLE_API_ISSUER }}
          # GitHub token
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup Keychain
        if: always()
        run: |
          security delete-keychain build.keychain || true

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v6
        with:
          name: macos-${{ matrix.arch }}
          path: |
            frontend/dist-electron/*.dmg
            frontend/dist-electron/*.pkg
            frontend/dist-electron/*.zip
          retention-days: 7

  # Build Linux packages
  build-linux:
    name: Build Linux
    needs: build-web
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download Next.js build
        uses: actions/download-artifact@v7
        with:
          name: nextjs-build
          path: frontend

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm fakeroot dpkg

      - name: Install Electron dependencies
        working-directory: frontend/platforms/electron
        run: npm install

      - name: Build Electron (TypeScript)
        working-directory: frontend/platforms/electron
        run: npm run build:all

      - name: Build Linux packages
        working-directory: frontend/platforms/electron
        run: npm run dist:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v6
        with:
          name: linux-x64
          path: |
            frontend/dist-electron/*.AppImage
            frontend/dist-electron/*.deb
            frontend/dist-electron/*.rpm
            frontend/dist-electron/*.tar.gz
          retention-days: 7

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts/

      - name: Display structure of downloaded files
        run: ls -R artifacts/

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release-notes.md << 'EOF'
          ## nchat Desktop v${{ steps.version.outputs.VERSION }}

          ### Downloads

          #### Windows
          - **Windows Installer (64-bit)**: `nchat-Setup-${{ steps.version.outputs.VERSION }}.exe`
          - **Windows Portable (64-bit)**: `nchat-${{ steps.version.outputs.VERSION }}-Portable.exe`

          #### macOS
          - **macOS DMG (Intel)**: `nchat-${{ steps.version.outputs.VERSION }}-mac-x64.dmg`
          - **macOS DMG (Apple Silicon)**: `nchat-${{ steps.version.outputs.VERSION }}-mac-arm64.dmg`
          - **macOS PKG (Intel)**: `nchat-${{ steps.version.outputs.VERSION }}-mac-x64.pkg`
          - **macOS PKG (Apple Silicon)**: `nchat-${{ steps.version.outputs.VERSION }}-mac-arm64.pkg`

          #### Linux
          - **AppImage (Universal)**: `nchat-${{ steps.version.outputs.VERSION }}-x86_64.AppImage`
          - **Debian/Ubuntu (.deb)**: `nchat_${{ steps.version.outputs.VERSION }}_amd64.deb`
          - **Fedora/RHEL (.rpm)**: `nchat-${{ steps.version.outputs.VERSION }}.x86_64.rpm`

          ### What's New

          - Complete production-ready desktop applications for all platforms
          - Auto-update support with UI prompts
          - System tray integration
          - Native notifications (macOS Notification Center, Windows Action Center)
          - Deep linking (nchat:// protocol)
          - Code signed and notarized installers
          - Performance optimizations

          ### Installation

          **Windows**: Download and run the `.exe` installer. Windows Defender SmartScreen may show a warning on first run - click "More info" and "Run anyway".

          **macOS**: Download the `.dmg` file, open it, and drag nchat to Applications. The app is notarized and will run without Gatekeeper warnings.

          **Linux**:
          - AppImage: Download, make executable (`chmod +x nchat-*.AppImage`), and run
          - Debian/Ubuntu: `sudo dpkg -i nchat_*.deb` or double-click to install via Software Center
          - Fedora/RHEL: `sudo rpm -i nchat-*.rpm` or double-click to install

          ### System Requirements

          - **Windows**: Windows 10 or later (64-bit)
          - **macOS**: macOS 10.15 (Catalina) or later
          - **Linux**: Modern distribution with glibc 2.28+

          ### Auto-Updates

          The desktop app will automatically check for updates and notify you when a new version is available.

          ---

          **Full Changelog**: https://github.com/nself/nself-chat/compare/v${{ steps.version.outputs.VERSION }}...main
          EOF

          cat release-notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Desktop v${{ steps.version.outputs.VERSION }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ inputs.prerelease || false }}
          files: |
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.pkg
            artifacts/**/*.zip
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup artifacts
        if: always()
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            nextjs-build
            windows-*
            macos-*
            linux-*
