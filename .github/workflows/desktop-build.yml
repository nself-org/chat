name: Desktop Build & Deploy

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Target platform'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - macos
          - windows
          - linux
      framework:
        description: 'Build framework'
        required: true
        default: 'electron'
        type: choice
        options:
          - electron
          - tauri
          - both
      create_release:
        description: 'Create GitHub release'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  build-electron-macos:
    name: Build Electron (macOS)
    runs-on: macos-14
    if: |
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'macos') &&
      (github.event.inputs.framework == 'electron' || github.event.inputs.framework == 'both' || github.event.inputs.framework == '')
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v5
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Setup Electron cache
        uses: actions/cache@v5
        with:
          path: |
            ~/Library/Caches/electron
            ~/Library/Caches/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('platforms/electron/package.json') }}
          restore-keys: ${{ runner.os }}-electron-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build Electron (macOS)
        run: pnpm electron:build --mac --universal
        env:
          CSC_LINK: ${{ secrets.MAC_CERTS }}
          CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notarize macOS app
        if: github.event_name != 'pull_request'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          chmod +x scripts/notarize-macos.sh
          for dmg in dist-electron/*.dmg; do
            if [ -f "$dmg" ]; then
              scripts/notarize-macos.sh "$dmg"
            fi
          done

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v6
        with:
          name: electron-macos-${{ env.VERSION }}
          path: |
            dist-electron/*.dmg
            dist-electron/*.zip
            dist-electron/*-mac.zip
          retention-days: 14

  build-electron-windows:
    name: Build Electron (Windows)
    runs-on: windows-latest
    if: |
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'windows') &&
      (github.event.inputs.framework == 'electron' || github.event.inputs.framework == 'both' || github.event.inputs.framework == '')
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v5
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Setup Electron cache
        uses: actions/cache@v5
        with:
          path: |
            ~\AppData\Local\electron\Cache
            ~\AppData\Local\electron-builder\Cache
          key: ${{ runner.os }}-electron-${{ hashFiles('platforms/electron/package.json') }}
          restore-keys: ${{ runner.os }}-electron-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build Electron (Windows)
        run: pnpm electron:build --win --x64 --ia32
        env:
          CSC_LINK: ${{ secrets.WIN_CERTS }}
          CSC_KEY_PASSWORD: ${{ secrets.WIN_CERTS_PASSWORD }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v6
        with:
          name: electron-windows-${{ env.VERSION }}
          path: |
            dist-electron/*.exe
            dist-electron/*.msi
          retention-days: 14

  build-electron-linux:
    name: Build Electron (Linux)
    runs-on: ubuntu-latest
    if: |
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'linux') &&
      (github.event.inputs.framework == 'electron' || github.event.inputs.framework == 'both' || github.event.inputs.framework == '')
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v5
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Setup Electron cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('platforms/electron/package.json') }}
          restore-keys: ${{ runner.os }}-electron-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build Electron (Linux)
        run: pnpm electron:build --linux --x64
        env:
          USE_HARD_LINKS: 'false'
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign Linux packages
        if: github.event_name != 'pull_request'
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          chmod +x scripts/sign-desktop.sh
          for pkg in dist-electron/*.{deb,rpm,AppImage}; do
            if [ -f "$pkg" ]; then
              scripts/sign-desktop.sh linux "$pkg" || true
            fi
          done

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v6
        with:
          name: electron-linux-${{ env.VERSION }}
          path: |
            dist-electron/*.deb
            dist-electron/*.rpm
            dist-electron/*.AppImage
            dist-electron/*.snap
            dist-electron/*.tar.gz
          retention-days: 14

  build-tauri-macos:
    name: Build Tauri (macOS)
    runs-on: macos-14
    if: |
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'macos') &&
      (github.event.inputs.framework == 'tauri' || github.event.inputs.framework == 'both')
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: platforms/tauri/src-tauri

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build Tauri (macOS)
        run: pnpm tauri build --target universal-apple-darwin
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload Tauri macOS artifacts
        uses: actions/upload-artifact@v6
        with:
          name: tauri-macos-${{ env.VERSION }}
          path: |
            platforms/tauri/src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
            platforms/tauri/src-tauri/target/universal-apple-darwin/release/bundle/macos/*.app
          retention-days: 14

  build-tauri-windows:
    name: Build Tauri (Windows)
    runs-on: windows-latest
    if: |
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'windows') &&
      (github.event.inputs.framework == 'tauri' || github.event.inputs.framework == 'both')
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: platforms/tauri/src-tauri

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build Tauri (Windows)
        run: pnpm tauri build
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

      - name: Upload Tauri Windows artifacts
        uses: actions/upload-artifact@v6
        with:
          name: tauri-windows-${{ env.VERSION }}
          path: |
            platforms/tauri/src-tauri/target/release/bundle/msi/*.msi
            platforms/tauri/src-tauri/target/release/bundle/nsis/*.exe
          retention-days: 14

  build-tauri-linux:
    name: Build Tauri (Linux)
    runs-on: ubuntu-latest
    if: |
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'linux') &&
      (github.event.inputs.framework == 'tauri' || github.event.inputs.framework == 'both')
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: platforms/tauri/src-tauri

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build Tauri (Linux)
        run: pnpm tauri build

      - name: Upload Tauri Linux artifacts
        uses: actions/upload-artifact@v6
        with:
          name: tauri-linux-${{ env.VERSION }}
          path: |
            platforms/tauri/src-tauri/target/release/bundle/deb/*.deb
            platforms/tauri/src-tauri/target/release/bundle/rpm/*.rpm
            platforms/tauri/src-tauri/target/release/bundle/appimage/*.AppImage
          retention-days: 14

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs:
      - build-electron-macos
      - build-electron-windows
      - build-electron-linux
    if: |
      always() &&
      github.event.inputs.create_release == 'true' &&
      github.event_name != 'pull_request' &&
      (needs.build-electron-macos.result == 'success' ||
       needs.build-electron-windows.result == 'success' ||
       needs.build-electron-linux.result == 'success')

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Generate changelog
        run: |
          chmod +x scripts/generate-changelog.sh
          scripts/generate-changelog.sh ${{ env.VERSION }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: Desktop Release v${{ env.VERSION }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Slack
        uses: slackapi/slack-github-action@v2
        with:
          payload: |
            {
              "text": "ðŸš€ Desktop Release v${{ env.VERSION }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Desktop Release v${{ env.VERSION }}* ðŸš€\n*Platforms:* macOS, Windows, Linux\n*Download:* https://github.com/${{ github.repository }}/releases/tag/v${{ env.VERSION }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
