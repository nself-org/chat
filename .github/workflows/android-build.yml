name: Android Build & Deploy

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
      output_format:
        description: 'Output format'
        required: true
        default: 'aab'
        type: choice
        options:
          - apk
          - aab
      deploy_playstore:
        description: 'Deploy to Play Store'
        required: false
        default: false
        type: boolean
      playstore_track:
        description: 'Play Store track'
        required: false
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '20'

jobs:
  build-android:
    name: Build Android App
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v5
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web app
        run: |
          pnpm build
          mkdir -p platforms/capacitor/out
          cp -r .next/standalone/* platforms/capacitor/out/
          cp -r .next/static platforms/capacitor/out/.next/static
          cp -r public platforms/capacitor/out/public
        env:
          NODE_ENV: production
          NEXT_PUBLIC_USE_DEV_AUTH: 'false'

      - name: Setup Capacitor
        working-directory: platforms/capacitor
        run: |
          pnpm install
          npx cap sync android

      - name: Update version
        working-directory: platforms/capacitor/android
        run: |
          VERSION=$(node -p "require('../../../package.json').version")
          VERSION_CODE=$(date +%Y%m%d%H%M)

          sed -i "s/versionName \".*\"/versionName \"$VERSION\"/" app/build.gradle
          sed -i "s/versionCode .*/versionCode $VERSION_CODE/" app/build.gradle

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV

      - name: Configure signing (Release)
        if: github.event.inputs.build_type == 'release' && github.event_name != 'pull_request'
        working-directory: platforms/capacitor/android
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          # Decode and save keystore
          mkdir -p keystore
          echo "$KEYSTORE_FILE" | base64 --decode > keystore/nchat-release.jks

          # Create keystore.properties
          cat > keystore.properties <<EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=keystore/nchat-release.jks
          EOF

      - name: Build Debug APK
        if: github.event.inputs.build_type == 'debug' || github.event_name == 'pull_request'
        working-directory: platforms/capacitor/android
        run: ./gradlew assembleDebug --stacktrace

      - name: Build Release AAB
        if: github.event.inputs.build_type == 'release' && github.event.inputs.output_format == 'aab' && github.event_name != 'pull_request'
        working-directory: platforms/capacitor/android
        run: ./gradlew bundleRelease --stacktrace

      - name: Build Release APK
        if: github.event.inputs.build_type == 'release' && github.event.inputs.output_format == 'apk' && github.event_name != 'pull_request'
        working-directory: platforms/capacitor/android
        run: ./gradlew assembleRelease --stacktrace

      - name: Sign APK
        if: github.event.inputs.build_type == 'release' && github.event.inputs.output_format == 'apk' && github.event_name != 'pull_request'
        working-directory: platforms/capacitor/android
        env:
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        run: |
          $ANDROID_SDK_ROOT/build-tools/34.0.0/zipalign -v -p 4 \
            app/build/outputs/apk/release/app-release-unsigned.apk \
            app/build/outputs/apk/release/app-release-aligned.apk

          $ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner sign \
            --ks keystore/nchat-release.jks \
            --ks-key-alias "$KEY_ALIAS" \
            --ks-pass pass:"$KEYSTORE_PASSWORD" \
            --key-pass pass:"$KEY_PASSWORD" \
            --out app/build/outputs/apk/release/app-release.apk \
            app/build/outputs/apk/release/app-release-aligned.apk

      - name: Copy outputs
        run: |
          mkdir -p platforms/capacitor/dist

          if [ "${{ github.event.inputs.build_type }}" == "debug" ] || [ "${{ github.event_name }}" == "pull_request" ]; then
            cp platforms/capacitor/android/app/build/outputs/apk/debug/app-debug.apk \
               platforms/capacitor/dist/nchat-debug.apk
          elif [ "${{ github.event.inputs.output_format }}" == "aab" ]; then
            cp platforms/capacitor/android/app/build/outputs/bundle/release/app-release.aab \
               platforms/capacitor/dist/nchat-release.aab
          else
            cp platforms/capacitor/android/app/build/outputs/apk/release/app-release.apk \
               platforms/capacitor/dist/nchat-release.apk
          fi

      - name: Upload Debug APK artifact
        if: github.event.inputs.build_type == 'debug' || github.event_name == 'pull_request'
        uses: actions/upload-artifact@v6
        with:
          name: nchat-android-debug-${{ env.VERSION }}-${{ env.VERSION_CODE }}
          path: platforms/capacitor/dist/nchat-debug.apk
          retention-days: 7

      - name: Upload Release AAB artifact
        if: github.event.inputs.build_type == 'release' && github.event.inputs.output_format == 'aab' && github.event_name != 'pull_request'
        uses: actions/upload-artifact@v6
        with:
          name: nchat-android-release-${{ env.VERSION }}-${{ env.VERSION_CODE }}
          path: platforms/capacitor/dist/nchat-release.aab
          retention-days: 30

      - name: Upload Release APK artifact
        if: github.event.inputs.build_type == 'release' && github.event.inputs.output_format == 'apk' && github.event_name != 'pull_request'
        uses: actions/upload-artifact@v6
        with:
          name: nchat-android-release-${{ env.VERSION }}-${{ env.VERSION_CODE }}
          path: platforms/capacitor/dist/nchat-release.apk
          retention-days: 30

      - name: Deploy to Play Store
        if: |
          github.event.inputs.build_type == 'release' &&
          github.event.inputs.output_format == 'aab' &&
          github.event_name != 'pull_request' &&
          (github.ref == 'refs/heads/main' || github.event.inputs.deploy_playstore == 'true')
        env:
          PLAY_STORE_JSON_KEY: ${{ secrets.PLAY_STORE_JSON_KEY }}
        run: |
          chmod +x scripts/deploy-playstore.sh
          scripts/deploy-playstore.sh \
            --track ${{ github.event.inputs.playstore_track || 'internal' }} \
            --aab platforms/capacitor/dist/nchat-release.aab

      - name: Build summary
        if: always()
        run: |
          echo "### Android Build Summary ü§ñ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Android |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Type | ${{ github.event.inputs.build_type || 'debug' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Output Format | ${{ github.event.inputs.output_format || 'apk' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ env.VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Code | ${{ env.VERSION_CODE }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Java Version | ${{ env.JAVA_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SDK Version | 34 |" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack on failure
        if: failure() && env.SLACK_WEBHOOK_URL != '' && github.event_name != 'pull_request'
        uses: slackapi/slack-github-action@v2
        with:
          payload: |
            {
              "text": "‚ùå Android Build Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Android Build Failed* ‚ùå\n*Version:* ${{ env.VERSION }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* `${{ github.sha }}`"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Notify Slack on success
        if: success() && env.SLACK_WEBHOOK_URL != '' && github.event.inputs.build_type == 'release' && github.event_name != 'pull_request'
        uses: slackapi/slack-github-action@v2
        with:
          payload: |
            {
              "text": "‚úÖ Android Build Successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Android Build Successful* ‚úÖ\n*Version:* ${{ env.VERSION }}\n*Build:* ${{ env.VERSION_CODE }}\n*Format:* ${{ github.event.inputs.output_format || 'apk' }}\n*Branch:* ${{ github.ref_name }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
