name: Deploy Docker

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Image tag to deploy'
        required: false
        default: 'latest'
        type: string
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
        default: 'staging'
      image_tag:
        required: false
        type: string
        default: 'latest'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy Docker Container
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          IMAGE_TAG: ${{ inputs.image_tag || 'latest' }}
        run: |
          ssh $DEPLOY_USER@$DEPLOY_HOST << 'ENDSSH'
            set -e

            # Navigate to deployment directory
            cd ${{ env.DEPLOY_PATH }}

            # Pull latest image
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

            # Stop and remove existing container
            docker stop nself-chat || true
            docker rm nself-chat || true

            # Start new container
            docker run -d \
              --name nself-chat \
              --restart unless-stopped \
              -p 3000:3000 \
              --env-file .env.production \
              -e NODE_ENV=production \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

            # Clean up old images
            docker image prune -f

            # Verify deployment
            sleep 10
            curl -f http://localhost:3000/api/health || exit 1

            echo "Deployment successful!"
          ENDSSH

      - name: Create deployment summary
        run: |
          echo "## Docker Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.image_tag || 'latest' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Host | ${{ secrets.DEPLOY_HOST }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
      - name: Notify on success
        if: needs.deploy.result == 'success'
        run: |
          echo "Deployment to ${{ inputs.environment }} successful!"

      - name: Notify on failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "Deployment to ${{ inputs.environment }} failed!"
          exit 1
