name: Deploy Android to Play Store

on:
  workflow_dispatch:
    inputs:
      track:
        description: 'Play Store track'
        required: true
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
        default: 'internal'
      rollout_percentage:
        description: 'Rollout percentage (for production only)'
        required: false
        type: string
        default: '10'
  push:
    tags:
      - 'mobile-android-v*'

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'
  RUBY_VERSION: '3.2'

jobs:
  deploy-android:
    name: Deploy Android
    runs-on: ubuntu-latest
    environment: play-store
    timeout-minutes: 45
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: false

      - name: Install Fastlane
        working-directory: .
        run: |
          gem install fastlane -v '~> 2.220.0'
          fastlane --version

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Get version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          VERSION_CODE=${{ github.run_number }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Deploying version $VERSION ($VERSION_CODE)"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web assets
        run: pnpm build
        env:
          NEXT_PUBLIC_USE_DEV_AUTH: 'false'
          NODE_ENV: production

      - name: Sync Capacitor
        working-directory: frontend/platforms/capacitor
        run: npx cap sync android

      - name: Decode Android keystore
        working-directory: frontend/platforms/capacitor/android
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > app/release.keystore
          ls -la app/release.keystore

      - name: Create keystore properties
        working-directory: frontend/platforms/capacitor/android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cat > keystore.properties <<EOF
          storeFile=release.keystore
          storePassword=$KEYSTORE_PASSWORD
          keyAlias=$KEY_ALIAS
          keyPassword=$KEY_PASSWORD
          EOF

      - name: Build Android release
        working-directory: frontend/platforms/capacitor
        env:
          NCHAT_RELEASE_STORE_FILE: app/release.keystore
          NCHAT_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          NCHAT_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          NCHAT_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          fastlane android release

      - name: Create Play Store service account file
        working-directory: .
        env:
          PLAY_STORE_JSON_KEY: ${{ secrets.PLAY_STORE_JSON_KEY }}
        run: |
          echo "$PLAY_STORE_JSON_KEY" > /tmp/play-store-key.json

      - name: Upload to Play Store (Internal)
        if: inputs.track == 'internal' || contains(github.ref, 'internal')
        working-directory: frontend/platforms/capacitor
        env:
          PLAY_STORE_JSON_KEY: /tmp/play-store-key.json
        run: |
          fastlane android internal

      - name: Upload to Play Store (Alpha)
        if: inputs.track == 'alpha'
        working-directory: frontend/platforms/capacitor
        env:
          PLAY_STORE_JSON_KEY: /tmp/play-store-key.json
        run: |
          fastlane android alpha

      - name: Upload to Play Store (Beta)
        if: inputs.track == 'beta'
        working-directory: frontend/platforms/capacitor
        env:
          PLAY_STORE_JSON_KEY: /tmp/play-store-key.json
        run: |
          fastlane android beta

      - name: Upload to Play Store (Production)
        if: inputs.track == 'production'
        working-directory: frontend/platforms/capacitor
        env:
          PLAY_STORE_JSON_KEY: /tmp/play-store-key.json
        run: |
          fastlane android deploy

      - name: Upload AAB/APK artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: android-release-${{ steps.version.outputs.version }}-${{ steps.version.outputs.version_code }}
          path: |
            frontend/platforms/capacitor/dist/android/*.aab
            frontend/platforms/capacitor/dist/android/*.apk
            frontend/platforms/capacitor/android/app/build/outputs/mapping/release/mapping.txt
          retention-days: 30

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: android-build-logs-${{ github.run_number }}
          path: |
            frontend/platforms/capacitor/fastlane/report.xml
            frontend/platforms/capacitor/android/app/build/reports
          retention-days: 7

      - name: Cleanup sensitive files
        if: always()
        working-directory: .
        run: |
          rm -f /tmp/play-store-key.json
          rm -f frontend/platforms/capacitor/android/app/release.keystore
          rm -f frontend/platforms/capacitor/android/keystore.properties

      - name: Notify on success
        if: success()
        run: |
          echo "üéâ Android app successfully deployed to Play Store (${{ inputs.track }} track)!"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Version Code: ${{ steps.version.outputs.version_code }}"
          echo "Check Play Console: https://play.google.com/console"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Android deployment failed"
          echo "Check the logs for details"
