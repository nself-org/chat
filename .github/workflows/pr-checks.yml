name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      src: ${{ steps.changes.outputs.src }}
      tests: ${{ steps.changes.outputs.tests }}
      config: ${{ steps.changes.outputs.config }}
      docs: ${{ steps.changes.outputs.docs }}
      mobile: ${{ steps.changes.outputs.mobile }}
      desktop: ${{ steps.changes.outputs.desktop }}
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
      packages: ${{ steps.changes.outputs.packages }}
      web: ${{ steps.changes.outputs.web }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.backend/**'
            frontend:
              - 'frontend/**'
            packages:
              - 'frontend/src/**'
              - 'frontend/pnpm-workspace.yaml'
            web:
              - 'frontend/apps/web/**'
            src:
              - 'frontend/src/**'
              - 'frontend/public/**'
            tests:
              - 'frontend/**/*.test.ts'
              - 'frontend/**/*.test.tsx'
              - 'frontend/**/*.spec.ts'
              - 'frontend/**/*.spec.tsx'
              - 'frontend/tests/e2e/**'
            config:
              - 'frontend/package.json'
              - 'frontend/pnpm-lock.yaml'
              - 'frontend/tsconfig.json'
              - 'frontend/jest.config.js'
              - 'frontend/next.config.js'
              - 'frontend/tailwind.config.ts'
            docs:
              - '*.md'
              - 'docs/**'
            mobile:
              - 'frontend/platforms/capacitor/**'
              - 'frontend/platforms/react-native/**'
            desktop:
              - 'frontend/platforms/electron/**'
              - 'frontend/platforms/tauri/**'

  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    needs: [changes]
    if: |
      needs.changes.outputs.backend == 'true' ||
      needs.changes.outputs.frontend == 'true' ||
      needs.changes.outputs.web == 'true' ||
      needs.changes.outputs.packages == 'true' ||
      needs.changes.outputs.src == 'true' ||
      needs.changes.outputs.config == 'true' ||
      needs.changes.outputs.mobile == 'true' ||
      needs.changes.outputs.desktop == 'true'
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint

      - name: Check formatting
        run: pnpm format:check

      - name: Comment on PR (Lint Failed)
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **Linting failed**\n\nPlease run `pnpm lint:fix` and `pnpm format` to fix issues.'
            })

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    needs: [changes]
    if: |
      needs.changes.outputs.backend == 'true' ||
      needs.changes.outputs.frontend == 'true' ||
      needs.changes.outputs.web == 'true' ||
      needs.changes.outputs.packages == 'true' ||
      needs.changes.outputs.src == 'true' ||
      needs.changes.outputs.config == 'true' ||
      needs.changes.outputs.mobile == 'true' ||
      needs.changes.outputs.desktop == 'true'
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript check
        run: pnpm type-check

      - name: Comment on PR (Type Check Failed)
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **Type checking failed**\n\nPlease fix TypeScript errors before merging.'
            })

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [changes]
    if: |
      needs.changes.outputs.src == 'true' ||
      needs.changes.outputs.tests == 'true' ||
      needs.changes.outputs.frontend == 'true' ||
      needs.changes.outputs.packages == 'true'
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test --coverage --ci

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./frontend/coverage/lcov.info
          fail_ci_if_error: false

      - name: Comment coverage on PR
        if: always()
        uses: romeovs/lcov-reporter-action@v0.4.0
        with:
          lcov-file: ./frontend/coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          delete-old-comments: true

  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [lint, type-check]
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web app
        run: pnpm build
        env:
          NEXT_PUBLIC_USE_DEV_AUTH: 'false'
          NODE_ENV: production

      - name: Check build size
        run: |
          BUILD_SIZE=$(du -sh .next | cut -f1)
          echo "Build size: $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY

  build-mobile:
    name: Mobile Build Check
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.mobile == 'true'
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web app
        run: pnpm build

      - name: Sync Capacitor
        working-directory: frontend/platforms/capacitor
        run: |
          pnpm install
          npx cap sync android --no-build

      - name: Build Android (Debug)
        working-directory: frontend/platforms/capacitor/android
        run: ./gradlew assembleDebug

  build-desktop:
    name: Desktop Build Check
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.desktop == 'true'
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check Electron build
        if: needs.changes.outputs.desktop == 'true'
        working-directory: frontend/platforms/electron
        run: |
          pnpm install
          pnpm build

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [changes]
    if: |
      needs.changes.outputs.backend == 'true' ||
      needs.changes.outputs.frontend == 'true' ||
      needs.changes.outputs.web == 'true' ||
      needs.changes.outputs.packages == 'true' ||
      needs.changes.outputs.src == 'true' ||
      needs.changes.outputs.config == 'true'
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: pnpm audit --audit-level=moderate || true

      - name: Run Snyk security scan
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    needs: [changes, build]
    if: |
      needs.changes.outputs.src == 'true' ||
      needs.changes.outputs.web == 'true' ||
      needs.changes.outputs.frontend == 'true'
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Analyze bundle
        run: pnpm build:analyze || true
        env:
          ANALYZE: 'true'
          NEXT_PUBLIC_USE_DEV_AUTH: 'false'

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: bundle-analysis
          path: frontend/.next/analyze/
          retention-days: 7

  accessibility:
    name: Accessibility Check
    runs-on: ubuntu-latest
    needs: [changes, build]
    if: |
      needs.changes.outputs.src == 'true' ||
      needs.changes.outputs.web == 'true' ||
      needs.changes.outputs.frontend == 'true'
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright
        run: pnpm playwright install --with-deps chromium

      - name: Build app
        run: pnpm build

      - name: Start server
        run: pnpm start &
        env:
          PORT: 3000

      - name: Wait for server
        run: npx wait-on http://localhost:3000 --timeout 60000

      - name: Run accessibility tests
        run: pnpm test:e2e --grep @a11y

  lighthouse:
    name: Lighthouse Performance
    runs-on: ubuntu-latest
    needs: [changes, build]
    if: |
      needs.changes.outputs.src == 'true' ||
      needs.changes.outputs.web == 'true' ||
      needs.changes.outputs.frontend == 'true'
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build app
        run: pnpm build

      - name: Run Lighthouse CI
        run: pnpm lighthouse || true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  status:
    name: PR Status Check
    runs-on: ubuntu-latest
    needs: [lint, type-check, test, build]
    if: always()
    steps:
      - name: Check required jobs
        run: |
          REQUIRED_JOBS=(
            "${{ needs.lint.result }}"
            "${{ needs.type-check.result }}"
            "${{ needs.test.result }}"
            "${{ needs.build.result }}"
          )

          FAILED=0
          for result in "${REQUIRED_JOBS[@]}"; do
            if [ "$result" = "failure" ]; then
              FAILED=1
            fi
          done

          if [ $FAILED -eq 1 ]; then
            echo "❌ One or more required checks failed"
            exit 1
          fi

          echo "✅ All required checks passed!"

      - name: Comment PR summary
        uses: actions/github-script@v8
        if: always()
        continue-on-error: true
        with:
          script: |
            const status = {
              lint: '${{ needs.lint.result }}',
              typeCheck: '${{ needs.type-check.result }}',
              test: '${{ needs.test.result }}',
              build: '${{ needs.build.result }}'
            };

            const emoji = (result) => {
              if (result === 'success') return '✅';
              if (result === 'failure') return '❌';
              if (result === 'skipped') return '⏭️';
              return '⏳';
            };

            const body = `## PR Checks Summary

            | Check | Status |
            |-------|--------|
            | Lint & Format | ${emoji(status.lint)} ${status.lint} |
            | Type Check | ${emoji(status.typeCheck)} ${status.typeCheck} |
            | Unit Tests | ${emoji(status.test)} ${status.test} |
            | Build | ${emoji(status.build)} ${status.build} |

            ---
            ${status.lint === 'failure' || status.typeCheck === 'failure' || status.test === 'failure' || status.build === 'failure' ?
              '❌ **Some checks failed.** Please review the errors above.' :
              '✅ **All checks passed!** Ready for review.'}
            `;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('PR Checks Summary')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            }
