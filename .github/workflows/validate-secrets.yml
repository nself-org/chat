name: Validate Secrets

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/.env.example'
      - 'frontend/.env.*'
      - 'docker/.env.*'
      - '.github/workflows/deploy-*.yml'
      - '.github/scripts/validate-secrets.ts'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to validate'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      strict:
        description: 'Strict mode (treat warnings as errors)'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  validate-development:
    name: Validate Development Secrets
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event.inputs.environment == 'development'

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate development secrets
        run: |
          pnpm tsx scripts/validate-secrets.ts \
            --env development \
            --output secrets-report-dev.json
        env:
          # Development secrets (minimal required)
          NEXT_PUBLIC_GRAPHQL_URL: http://api.localhost/v1/graphql
          NEXT_PUBLIC_AUTH_URL: http://auth.localhost/v1/auth
          NEXT_PUBLIC_STORAGE_URL: http://storage.localhost/v1/storage
          NEXT_PUBLIC_USE_DEV_AUTH: 'true'

      - name: Upload development report
        uses: actions/upload-artifact@v6
        with:
          name: secrets-report-development
          path: frontend/secrets-report-dev.json
          retention-days: 30

  validate-staging:
    name: Validate Staging Secrets
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'staging' || (github.event_name == 'pull_request' && contains(github.head_ref, 'release/'))

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate staging secrets
        run: |
          pnpm tsx scripts/validate-secrets.ts \
            --env staging \
            --strict \
            --output secrets-report-staging.json
        env:
          # Core backend
          NEXT_PUBLIC_GRAPHQL_URL: ${{ secrets.STAGING_GRAPHQL_URL }}
          NEXT_PUBLIC_AUTH_URL: ${{ secrets.STAGING_AUTH_URL }}
          NEXT_PUBLIC_STORAGE_URL: ${{ secrets.STAGING_STORAGE_URL }}
          NEXT_PUBLIC_USE_DEV_AUTH: 'false'
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          HASURA_ADMIN_SECRET: ${{ secrets.STAGING_HASURA_ADMIN_SECRET }}
          JWT_SECRET: ${{ secrets.STAGING_JWT_SECRET }}

          # Storage
          STORAGE_ACCESS_KEY: ${{ secrets.STAGING_STORAGE_ACCESS_KEY }}
          STORAGE_SECRET_KEY: ${{ secrets.STAGING_STORAGE_SECRET_KEY }}

          # Search
          MEILISEARCH_MASTER_KEY: ${{ secrets.STAGING_MEILISEARCH_MASTER_KEY }}

          # Payments (test mode)
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_TEST_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_TEST_PUBLISHABLE_KEY }}

          # Monitoring
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

      - name: Upload staging report
        uses: actions/upload-artifact@v6
        with:
          name: secrets-report-staging
          path: frontend/secrets-report-staging.json
          retention-days: 30

      - name: Comment PR with staging results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('frontend/secrets-report-staging.json', 'utf8'));

            const status = report.criticalFailures.length > 0 ? 'âŒ' :
                          report.summary.failed > 0 ? 'âš ï¸' : 'âœ…';

            const body = `
            ## ${status} Staging Secrets Validation

            **Environment:** ${report.environment}
            **Timestamp:** ${report.timestamp}

            ### Summary
            - Total: ${report.summary.total}
            - âœ… Passed: ${report.summary.passed}
            - âŒ Failed: ${report.summary.failed}
            - âš ï¸ Warnings: ${report.summary.warnings}
            - â­ï¸ Skipped: ${report.summary.skipped}

            ${report.criticalFailures.length > 0 ? `
            ### ðŸš¨ Critical Failures
            ${report.criticalFailures.map(f => `- \`${f}\``).join('\n')}
            ` : ''}

            ${report.recommendations.length > 0 ? `
            ### ðŸ’¡ Recommendations
            ${report.recommendations.map(r => `- ${r}`).join('\n')}
            ` : ''}

            <details>
            <summary>View detailed report</summary>

            \`\`\`json
            ${JSON.stringify(report, null, 2)}
            \`\`\`

            </details>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  validate-production:
    name: Validate Production Secrets
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production'
    environment: production

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate production secrets
        run: |
          pnpm tsx scripts/validate-secrets.ts \
            --env production \
            --strict \
            --output secrets-report-production.json
        env:
          # Core backend (REQUIRED)
          NEXT_PUBLIC_GRAPHQL_URL: ${{ secrets.PRODUCTION_GRAPHQL_URL }}
          NEXT_PUBLIC_AUTH_URL: ${{ secrets.PRODUCTION_AUTH_URL }}
          NEXT_PUBLIC_STORAGE_URL: ${{ secrets.PRODUCTION_STORAGE_URL }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.PRODUCTION_APP_URL }}
          NEXT_PUBLIC_USE_DEV_AUTH: 'false'
          NODE_ENV: production

          # Database (REQUIRED)
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}

          # Hasura (REQUIRED)
          HASURA_ADMIN_SECRET: ${{ secrets.PRODUCTION_HASURA_ADMIN_SECRET }}
          JWT_SECRET: ${{ secrets.PRODUCTION_JWT_SECRET }}

          # Storage (REQUIRED)
          STORAGE_ACCESS_KEY: ${{ secrets.PRODUCTION_STORAGE_ACCESS_KEY }}
          STORAGE_SECRET_KEY: ${{ secrets.PRODUCTION_STORAGE_SECRET_KEY }}

          # Search (REQUIRED)
          MEILISEARCH_MASTER_KEY: ${{ secrets.PRODUCTION_MEILISEARCH_MASTER_KEY }}

          # OAuth (Optional)
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GITHUB_CLIENT_ID: ${{ secrets.GITHUB_CLIENT_ID }}
          GITHUB_CLIENT_SECRET: ${{ secrets.GITHUB_CLIENT_SECRET }}
          MICROSOFT_CLIENT_ID: ${{ secrets.MICROSOFT_CLIENT_ID }}
          MICROSOFT_CLIENT_SECRET: ${{ secrets.MICROSOFT_CLIENT_SECRET }}

          # Payments (REQUIRED if billing enabled)
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}

          # Monitoring (REQUIRED)
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ secrets.GA_MEASUREMENT_ID }}

          # Email (REQUIRED)
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}

          # LiveKit (Optional)
          LIVEKIT_API_KEY: ${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET: ${{ secrets.LIVEKIT_API_SECRET }}
          NEXT_PUBLIC_LIVEKIT_URL: ${{ secrets.LIVEKIT_URL }}

          # Redis (Optional)
          REDIS_URL: ${{ secrets.REDIS_URL }}

      - name: Upload production report
        uses: actions/upload-artifact@v6
        with:
          name: secrets-report-production
          path: frontend/secrets-report-production.json
          retention-days: 90

      - name: Fail on critical issues
        run: |
          if jq -e '.criticalFailures | length > 0' secrets-report-production.json > /dev/null; then
            echo "âŒ Critical secrets validation failures detected"
            jq -r '.criticalFailures[]' secrets-report-production.json
            exit 1
          fi

          if jq -e '.summary.failed > 0' secrets-report-production.json > /dev/null; then
            echo "âŒ Secrets validation failed"
            jq '.results[] | select(.status == "fail")' secrets-report-production.json
            exit 1
          fi

          echo "âœ… All production secrets validated successfully"

  check-for-leaked-secrets:
    name: Scan for Leaked Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  validate-example-files:
    name: Validate Example Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check .env.example is up to date
        run: |
          # Extract variable names from .env.example
          grep -v "^#" frontend/.env.example | grep "=" | cut -d= -f1 | sort > example-vars.txt

          # Extract variable names from validation script
          grep "name: '" .github/scripts/validate-secrets.ts | \
            sed "s/.*name: '\(.*\)'.*/\1/" | sort > script-vars.txt

          # Compare
          if ! diff -u example-vars.txt script-vars.txt > vars-diff.txt; then
            echo "âŒ Mismatch between .env.example and validation script"
            echo ""
            echo "Variables in .env.example but not in validation script:"
            grep "^-" vars-diff.txt || true
            echo ""
            echo "Variables in validation script but not in .env.example:"
            grep "^+" vars-diff.txt || true
            echo ""
            echo "Please update frontend/.env.example or .github/scripts/validate-secrets.ts"
            exit 1
          fi

          echo "âœ… .env.example and validation script are in sync"

      - name: Check for placeholder values in examples
        run: |
          # Find placeholder values that might have been accidentally committed
          if grep -r "sk_live_" --include="*.example" --include="*.md" .; then
            echo "âŒ Found potential live Stripe key in example files"
            exit 1
          fi

          if grep -r "AKIA" --include="*.example" --include="*.md" .; then
            echo "âŒ Found potential AWS access key in example files"
            exit 1
          fi

          echo "âœ… No sensitive values found in example files"

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-development, validate-staging, validate-production, check-for-leaked-secrets, validate-example-files]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "## Secrets Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Development | ${{ needs.validate-development.result == 'success' && 'âœ… Passed' || needs.validate-development.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | ${{ needs.validate-staging.result == 'success' && 'âœ… Passed' || needs.validate-staging.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Production | ${{ needs.validate-production.result == 'success' && 'âœ… Passed' || needs.validate-production.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Leaked Secrets | ${{ needs.check-for-leaked-secrets.result == 'success' && 'âœ… None Found' || 'âŒ Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Example Files | ${{ needs.validate-example-files.result == 'success' && 'âœ… Valid' || 'âŒ Invalid' }} |" >> $GITHUB_STEP_SUMMARY
