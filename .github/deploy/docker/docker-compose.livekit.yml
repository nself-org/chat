version: '3.8'

# LiveKit Server for WebRTC Voice & Video Calls
# Provides SFU (Selective Forwarding Unit) for efficient multi-party calls

services:
  # LiveKit Server
  livekit:
    image: livekit/livekit-server:v1.5
    container_name: nself-livekit
    command: --config /livekit.yaml
    ports:
      - '7880:7880' # HTTP API
      - '7881:7881/tcp' # WebRTC TCP
      - '7881:7881/udp' # WebRTC UDP
      - '7882:7882/udp' # TURN UDP
      - '50000-60000:50000-60000/udp' # WebRTC media ports
    volumes:
      - ./livekit.yaml:/livekit.yaml:ro
    environment:
      - LIVEKIT_KEYS=${LIVEKIT_API_KEY}:${LIVEKIT_API_SECRET}
    networks:
      - nself-network
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:7880/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # LiveKit Egress (for recording and streaming)
  # Uncomment to enable recording features
  # livekit-egress:
  #   image: livekit/egress:latest
  #   container_name: nself-livekit-egress
  #   environment:
  #     - LIVEKIT_URL=ws://livekit:7880
  #     - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
  #     - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
  #   volumes:
  #     - ./recordings:/recordings
  #   networks:
  #     - nself-network
  #   depends_on:
  #     - livekit

  # LiveKit Ingress (for streaming input sources)
  # Uncomment to enable RTMP streaming
  # livekit-ingress:
  #   image: livekit/ingress:latest
  #   container_name: nself-livekit-ingress
  #   environment:
  #     - LIVEKIT_URL=ws://livekit:7880
  #     - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
  #     - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
  #   ports:
  #     - "1935:1935"  # RTMP
  #     - "8086:8086"  # WHIP
  #   networks:
  #     - nself-network
  #   depends_on:
  #     - livekit

networks:
  nself-network:
    external: true

# Usage:
# 1. Generate API keys:
#    LIVEKIT_API_KEY=$(openssl rand -hex 16)
#    LIVEKIT_API_SECRET=$(openssl rand -hex 32)
#
# 2. Add to .env:
#    LIVEKIT_API_KEY=your_api_key
#    LIVEKIT_API_SECRET=your_api_secret
#    NEXT_PUBLIC_LIVEKIT_URL=ws://localhost:7880
#
# 3. Start LiveKit:
#    docker-compose -f docker-compose.livekit.yml up -d
#
# 4. Verify:
#    curl http://localhost:7880/
