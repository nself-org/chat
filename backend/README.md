# nchat Backend

Production-ready backend infrastructure powered by [nself CLI](https://github.com/nself-org/cli).

## Quick Start

```bash
# Build the project (generates docker-compose.yml)
nself build

# Start all services
nself start

# Check status
nself status

# View service URLs
nself urls
```

## Services

| Service     | Port      | Description              |
| ----------- | --------- | ------------------------ |
| PostgreSQL  | 5432      | Primary database         |
| Hasura      | 8080      | GraphQL Engine           |
| Auth        | 4000      | Nhost Authentication     |
| MinIO       | 9000/9001 | S3-compatible storage    |
| Redis       | 6379      | Cache and sessions       |
| MeiliSearch | 7700      | Full-text search         |
| Mailpit     | 8025      | Email testing (dev only) |
| Nginx       | 80/443    | Reverse proxy            |

## Directory Structure

```
backend/
├── .env                    # Local development config
├── .env.example            # Reference documentation
├── .env.secrets            # Secrets (git-ignored)
├── .env.staging            # Staging environment
├── .env.prod               # Production environment
├── .gitignore              # Git ignore rules
├── schema.dbml             # Database schema (DBML)
├── docker-compose.yml      # Generated by nself build
├── migrations/             # SQL migrations
│   ├── *_enum_types.sql
│   ├── *_imported_schema.sql
│   ├── *_foreign_keys.sql
│   ├── *_indexes_and_triggers.sql
│   └── *_seed_data.sql
├── hasura/                 # Hasura metadata
├── nginx/                  # Nginx configuration
├── postgres/               # PostgreSQL init scripts
├── auth/                   # Auth service config
├── ssl/                    # SSL certificates
└── services/               # Custom services
```

## Database Schema

The schema is defined in `schema.dbml` (Database Markup Language). It includes:

### Core Tables (35 tables)

- **Users**: `nchat_users`, `nchat_profiles`, `nchat_presence`, `nchat_user_settings`
- **Channels**: `nchat_categories`, `nchat_channels`, `nchat_channel_members`
- **Messages**: `nchat_messages`, `nchat_threads`, `nchat_thread_members`, `nchat_reactions`
- **Media**: `nchat_attachments`, `nchat_media`, `nchat_custom_emojis`
- **Notifications**: `nchat_notifications`, `nchat_push_subscriptions`
- **Workspaces**: `nchat_workspaces`, `nchat_workspace_members`, `nchat_workspace_invites`
- **RBAC**: `nchat_roles`, `nchat_user_roles`, `nchat_permissions`
- **Billing**: `nchat_plans`, `nchat_subscriptions`, `nchat_invoices`
- **Integrations**: `nchat_integrations`, `nchat_webhooks`, `nchat_incoming_webhooks`, `nchat_bots`
- **Other**: `nchat_bookmarks`, `nchat_pinned_messages`, `nchat_search_index`, `nchat_audit_logs`, `nchat_app_configuration`, `nchat_sessions`

### Enum Types

- `user_status`: active, inactive, suspended, deleted
- `presence_status`: online, away, dnd, offline, invisible
- `channel_type`: public, private, direct, group, announcement
- `message_type`: text, system, bot, file, voice, video, embed
- `member_role`: owner, admin, moderator, member, guest
- `notification_type`: message, mention, reaction, thread_reply, channel_invite, system
- `attachment_type`: image, video, audio, document, archive, other
- `subscription_status`: trialing, active, past_due, canceled, unpaid
- `audit_action`: create, read, update, delete, login, logout, etc.

## Database Commands

```bash
# Run pending migrations
nself db migrate up

# Check migration status
nself db migrate status

# Generate TypeScript types
nself db types typescript

# Open database shell
nself db shell

# Create a backup
nself db backup database --compress

# Seed development data
nself db seed
```

## Environment Configuration

### Development (.env)

- Uses local domain: `local.nself.org`
- Dev tools enabled: Mailpit, nself-admin
- Auto-reload for schema changes

### Staging (.env.staging)

- Domain: `staging.nchat.io`
- Monitoring enabled
- Email verification required

### Production (.env.prod)

- Domain: `nchat.io`
- Full security: HTTPS, secure cookies, rate limiting
- Monitoring and audit logs enabled

## Secrets

All secrets are stored in `.env.secrets` (git-ignored):

- `POSTGRES_PASSWORD`
- `HASURA_GRAPHQL_ADMIN_SECRET`
- `HASURA_GRAPHQL_JWT_SECRET`
- `AUTH_JWT_SECRET`
- `MINIO_ROOT_PASSWORD`
- `MEILI_MASTER_KEY`

**Important**: Generate strong secrets for production!

```bash
# Generate a secure secret
openssl rand -base64 32
```

## GraphQL API

Once running, access the GraphQL console at:

- **Hasura Console**: http://api.local.nself.org/console
- **GraphQL Endpoint**: http://api.local.nself.org/v1/graphql

## Health Checks

All services include health checks. View status with:

```bash
nself status
nself doctor  # Full diagnostics
```

## Backups

```bash
# Create full backup
nself db backup full --compress

# List backups
nself db backup list

# Restore from backup
nself db restore <backup-name>
```

## Troubleshooting

```bash
# View logs
nself logs           # All services
nself logs postgres  # Specific service
nself logs -f        # Follow mode

# Restart services
nself restart

# Reset to clean state
nself reset
```

## Related Links

- [nself CLI Documentation](https://nself.org/docs)
- [Hasura Documentation](https://hasura.io/docs)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
