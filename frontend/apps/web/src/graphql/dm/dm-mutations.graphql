# Direct Message Mutations
# GraphQL mutations for DM operations

# ============================================================================
# DM Creation
# ============================================================================

# Create a new 1:1 DM or get existing one
mutation CreateOrGetDM($creatorId: uuid!, $participantId: uuid!) {
  insert_nchat_direct_messages_one(
    object: {
      type: "direct"
      slug: "" # Will be generated by trigger
      created_by: $creatorId
      participants: {
        data: [{ user_id: $creatorId, role: "member" }, { user_id: $participantId, role: "member" }]
      }
    }
    on_conflict: { constraint: nchat_direct_messages_dm_unique, update_columns: [updated_at] }
  ) {
    id
    slug
    type
    participants {
      user {
        id
        username
        display_name
        avatar_url
      }
    }
  }
}

# Create a new group DM
mutation CreateGroupDM(
  $name: String!
  $description: String
  $creatorId: uuid!
  $participantIds: [nchat_dm_participants_insert_input!]!
) {
  insert_nchat_direct_messages_one(
    object: {
      type: "group"
      name: $name
      description: $description
      slug: "" # Will be generated
      created_by: $creatorId
      participants: { data: $participantIds }
    }
  ) {
    id
    slug
    type
    name
    description
    participants {
      user_id
      role
      user {
        id
        username
        display_name
        avatar_url
      }
    }
  }
}

# ============================================================================
# DM Updates
# ============================================================================

# Update DM settings (group only)
mutation UpdateDMSettings($dmId: uuid!, $name: String, $description: String, $avatarUrl: String) {
  update_nchat_direct_messages_by_pk(
    pk_columns: { id: $dmId }
    _set: { name: $name, description: $description, avatar_url: $avatarUrl, updated_at: "now()" }
  ) {
    id
    name
    description
    avatar_url
    updated_at
  }
}

# Archive a DM
mutation ArchiveDM($dmId: uuid!, $userId: uuid!) {
  update_nchat_direct_messages_by_pk(
    pk_columns: { id: $dmId }
    _set: { status: "archived", archived_at: "now()", archived_by: $userId }
  ) {
    id
    status
    archived_at
    archived_by
  }
}

# Unarchive a DM
mutation UnarchiveDM($dmId: uuid!) {
  update_nchat_direct_messages_by_pk(
    pk_columns: { id: $dmId }
    _set: { status: "active", archived_at: null, archived_by: null }
  ) {
    id
    status
  }
}

# Delete a DM (soft delete)
mutation DeleteDM($dmId: uuid!) {
  update_nchat_direct_messages_by_pk(pk_columns: { id: $dmId }, _set: { status: "deleted" }) {
    id
    status
  }
}

# ============================================================================
# Participant Management
# ============================================================================

# Add participants to group DM
mutation AddDMParticipants($participants: [nchat_dm_participants_insert_input!]!) {
  insert_nchat_dm_participants(
    objects: $participants
    on_conflict: { constraint: nchat_dm_participants_dm_id_user_id_key, update_columns: [] }
  ) {
    affected_rows
    returning {
      id
      user_id
      dm_id
      role
      user {
        id
        username
        display_name
        avatar_url
      }
    }
  }
}

# Remove participant from group DM
mutation RemoveDMParticipant($dmId: uuid!, $userId: uuid!) {
  delete_nchat_dm_participants(where: { dm_id: { _eq: $dmId }, user_id: { _eq: $userId } }) {
    affected_rows
  }
}

# Update participant role
mutation UpdateDMParticipantRole($dmId: uuid!, $userId: uuid!, $role: String!) {
  update_nchat_dm_participants(
    where: { dm_id: { _eq: $dmId }, user_id: { _eq: $userId } }
    _set: { role: $role }
  ) {
    affected_rows
    returning {
      id
      user_id
      role
    }
  }
}

# Leave a DM
mutation LeaveDM($dmId: uuid!, $userId: uuid!) {
  delete_nchat_dm_participants(where: { dm_id: { _eq: $dmId }, user_id: { _eq: $userId } }) {
    affected_rows
  }
}

# Transfer group ownership
mutation TransferDMOwnership($dmId: uuid!, $currentOwnerId: uuid!, $newOwnerId: uuid!) {
  # Demote current owner to admin
  update_current: update_nchat_dm_participants(
    where: { dm_id: { _eq: $dmId }, user_id: { _eq: $currentOwnerId } }
    _set: { role: "admin" }
  ) {
    affected_rows
  }
  # Promote new owner
  update_new: update_nchat_dm_participants(
    where: { dm_id: { _eq: $dmId }, user_id: { _eq: $newOwnerId } }
    _set: { role: "owner" }
  ) {
    affected_rows
  }
}

# ============================================================================
# Messages
# ============================================================================

# Send a message
mutation SendDMMessage(
  $dmId: uuid!
  $userId: uuid!
  $content: String!
  $type: String = "text"
  $replyToId: uuid
  $metadata: jsonb
) {
  insert_nchat_dm_messages_one(
    object: {
      dm_id: $dmId
      user_id: $userId
      content: $content
      type: $type
      reply_to_id: $replyToId
      metadata: $metadata
    }
  ) {
    id
    dm_id
    user_id
    content
    type
    reply_to_id
    created_at
    user {
      id
      username
      display_name
      avatar_url
    }
    reply_to {
      id
      content
      user {
        id
        username
        display_name
      }
    }
  }
}

# Update a message
mutation UpdateDMMessage($messageId: uuid!, $content: String!) {
  update_nchat_dm_messages_by_pk(
    pk_columns: { id: $messageId }
    _set: { content: $content, is_edited: true, edited_at: "now()" }
  ) {
    id
    content
    is_edited
    edited_at
  }
}

# Delete a message (soft delete)
mutation DeleteDMMessage($messageId: uuid!) {
  update_nchat_dm_messages_by_pk(
    pk_columns: { id: $messageId }
    _set: { is_deleted: true, deleted_at: "now()" }
  ) {
    id
    is_deleted
    deleted_at
  }
}

# Pin a message
mutation PinDMMessage($messageId: uuid!) {
  update_nchat_dm_messages_by_pk(pk_columns: { id: $messageId }, _set: { is_pinned: true }) {
    id
    is_pinned
  }
}

# Unpin a message
mutation UnpinDMMessage($messageId: uuid!) {
  update_nchat_dm_messages_by_pk(pk_columns: { id: $messageId }, _set: { is_pinned: false }) {
    id
    is_pinned
  }
}

# ============================================================================
# Reactions
# ============================================================================

# Add reaction to message
mutation AddDMReaction($messageId: uuid!, $userId: uuid!, $emoji: String!) {
  insert_nchat_dm_reactions_one(
    object: { message_id: $messageId, user_id: $userId, emoji: $emoji }
    on_conflict: { constraint: nchat_dm_reactions_message_id_user_id_emoji_key, update_columns: [] }
  ) {
    id
    message_id
    user_id
    emoji
    created_at
  }
}

# Remove reaction from message
mutation RemoveDMReaction($messageId: uuid!, $userId: uuid!, $emoji: String!) {
  delete_nchat_dm_reactions(
    where: { message_id: { _eq: $messageId }, user_id: { _eq: $userId }, emoji: { _eq: $emoji } }
  ) {
    affected_rows
  }
}

# ============================================================================
# Read Status
# ============================================================================

# Mark DM as read
mutation MarkDMAsRead($dmId: uuid!, $userId: uuid!, $messageId: uuid!) {
  update_nchat_dm_participants(
    where: { dm_id: { _eq: $dmId }, user_id: { _eq: $userId } }
    _set: { last_read_at: "now()", last_read_message_id: $messageId }
  ) {
    affected_rows
    returning {
      id
      last_read_at
      last_read_message_id
    }
  }
}

# Send read receipt
mutation SendDMReadReceipt($messageId: uuid!, $userId: uuid!) {
  insert_nchat_dm_read_receipts_one(
    object: { message_id: $messageId, user_id: $userId }
    on_conflict: {
      constraint: nchat_dm_read_receipts_message_id_user_id_key
      update_columns: [read_at]
    }
  ) {
    id
    message_id
    user_id
    read_at
  }
}

# ============================================================================
# Notifications
# ============================================================================

# Update notification settings for a DM
mutation UpdateDMNotificationSettings(
  $dmId: uuid!
  $userId: uuid!
  $setting: String!
  $isMuted: Boolean
  $mutedUntil: timestamptz
) {
  update_nchat_dm_participants(
    where: { dm_id: { _eq: $dmId }, user_id: { _eq: $userId } }
    _set: { notification_setting: $setting, is_muted: $isMuted, muted_until: $mutedUntil }
  ) {
    affected_rows
    returning {
      id
      notification_setting
      is_muted
      muted_until
    }
  }
}

# Mute a DM
mutation MuteDM($dmId: uuid!, $userId: uuid!, $mutedUntil: timestamptz) {
  update_nchat_dm_participants(
    where: { dm_id: { _eq: $dmId }, user_id: { _eq: $userId } }
    _set: { is_muted: true, muted_until: $mutedUntil }
  ) {
    affected_rows
    returning {
      id
      is_muted
      muted_until
    }
  }
}

# Unmute a DM
mutation UnmuteDM($dmId: uuid!, $userId: uuid!) {
  update_nchat_dm_participants(
    where: { dm_id: { _eq: $dmId }, user_id: { _eq: $userId } }
    _set: { is_muted: false, muted_until: null }
  ) {
    affected_rows
    returning {
      id
      is_muted
    }
  }
}

# ============================================================================
# Typing Indicators
# ============================================================================

# Set typing indicator
mutation SetDMTyping($dmId: uuid!, $userId: uuid!) {
  insert_nchat_dm_typing_indicators_one(
    object: { dm_id: $dmId, user_id: $userId, expires_at: "now() + interval '5 seconds'" }
    on_conflict: {
      constraint: nchat_dm_typing_indicators_dm_id_user_id_key
      update_columns: [started_at, expires_at]
    }
  ) {
    dm_id
    user_id
    started_at
    expires_at
  }
}

# Clear typing indicator
mutation ClearDMTyping($dmId: uuid!, $userId: uuid!) {
  delete_nchat_dm_typing_indicators(where: { dm_id: { _eq: $dmId }, user_id: { _eq: $userId } }) {
    affected_rows
  }
}

# ============================================================================
# Attachments
# ============================================================================

# Add attachment to message
mutation AddDMAttachment(
  $messageId: uuid!
  $fileName: String!
  $fileType: String!
  $fileSize: Int!
  $fileUrl: String!
  $thumbnailUrl: String
  $width: Int
  $height: Int
  $duration: Int
  $metadata: jsonb
) {
  insert_nchat_dm_attachments_one(
    object: {
      message_id: $messageId
      file_name: $fileName
      file_type: $fileType
      file_size: $fileSize
      file_url: $fileUrl
      thumbnail_url: $thumbnailUrl
      width: $width
      height: $height
      duration: $duration
      metadata: $metadata
    }
  ) {
    id
    message_id
    file_name
    file_type
    file_size
    file_url
    thumbnail_url
    width
    height
    duration
    created_at
  }
}

# Delete attachment
mutation DeleteDMAttachment($attachmentId: uuid!) {
  delete_nchat_dm_attachments_by_pk(id: $attachmentId) {
    id
    file_url
  }
}
